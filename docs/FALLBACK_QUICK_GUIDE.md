# üîÑ Fallback –ú–µ—Ö–∞–Ω–∏–∑–º - –ë—ã—Å—Ç—Ä—ã–π –ì–∞–π–¥

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù (22.11.2025 15:17)

---

## üìä –¢–µ–∫—É—â–∏–π –°—Ç–∞—Ç—É—Å

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞
ps aux | grep telegram_bot.py | grep -v grep
# ‚Üí PID 3531397 ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

# –ü—Ä–æ–≤–µ—Ä–∫–∞ fallback
tail -5 bot.log | grep "Gemini"
# ‚Üí "‚úÖ Gemini Direct API fallback enabled" ‚úÖ –í–ö–õ–Æ–ß–Å–ù
```

---

## üöÄ –ö–∞–∫ –†–∞–±–æ—Ç–∞–µ—Ç –°–µ–π—á–∞—Å

**OpenRouter –∫–ª—é—á–∏:** –í–°–ï 4 –ò–°–ß–ï–†–ü–ê–ù–´ (429 rate limit –¥–æ 23.11.2025 00:00 UTC)

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ/—Ñ–æ—Ç–æ
2. –ë–æ—Ç –ø—Ä–æ–±—É–µ—Ç OpenRouter –∫–ª—é—á #1 ‚Üí 429
3. –ë–æ—Ç –ø—Ä–æ–±—É–µ—Ç OpenRouter –∫–ª—é—á #2 ‚Üí 429
4. –ë–æ—Ç –ø—Ä–æ–±—É–µ—Ç OpenRouter –∫–ª—é—á #3 ‚Üí 429
5. –ë–æ—Ç –ø—Ä–æ–±—É–µ—Ç OpenRouter –∫–ª—é—á #4 ‚Üí 429
6. **üîÑ FALLBACK:** –ë–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ Gemini Direct API
7. **‚úÖ –£–°–ü–ï–•:** –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:** ~17 —Å–µ–∫—É–Ω–¥ (4 –∫–ª—é—á–∞ √ó 4s + 1s Gemini)

---

## üìù –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –õ–æ–≥–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

```bash
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f bot.log | grep -E "fallback|429|Gemini"
```

**–û–∂–∏–¥–∞–µ–º—ã–π output:**
```
‚ö†Ô∏è Rate Limit (429) on key ending ...7c4dd. Retrying...
‚ö†Ô∏è Rate Limit (429) on key ending ...ba1cb. Retrying...
‚ö†Ô∏è Rate Limit (429) on key ending ...6fe80. Retrying...
‚ö†Ô∏è Rate Limit (429) on key ending ...c82d3. Retrying...
üîÑ All OpenRouter keys rate limited. Switching to Gemini Direct API...
[–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞):

1. –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–∏–≤–µ—Ç")
2. –ñ–¥–∏ ~17 —Å–µ–∫—É–Ω–¥
3. –ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç (—á–µ—Ä–µ–∑ Gemini fallback)

### E2E —Ç–µ—Å—Ç (—á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç):

```bash
cd ~/ConstructionAI_System
source venv/bin/activate
python3 test_fallback.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ TEXT: PASSED
‚úÖ VISION: PASSED
‚ö†Ô∏è JSON: FAILED (–Ω–æ—Ä–º–∞–ª—å–Ω–æ, Gemini –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç response_format)
```

---

## ‚è∞ –ö–æ–≥–¥–∞ OpenRouter –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è

**–°–±—Ä–æ—Å rate limit:** 23.11.2025 00:00 UTC (~9 —á–∞—Å–æ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
- OpenRouter –∫–ª—é—á–∏ —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –∏–º–µ—Ç—å 50/50 –∑–∞–ø—Ä–æ—Å–æ–≤
- –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenRouter (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- Gemini –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–∞–∫ fallback –Ω–∞ —Å–ª—É—á–∞–π —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è

**–ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è** - –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

---

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
ps aux | grep telegram_bot.py | grep -v grep

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
cd ~/ConstructionAI_System && ./start.sh

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
pkill -f telegram_bot.py

# –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫)
tail -50 bot.log

# –õ–æ–≥–∏ (real-time)
tail -f bot.log

# –õ–æ–≥–∏ (—Ç–æ–ª—å–∫–æ fallback —Å–æ–±—ã—Ç–∏—è)
tail -f bot.log | grep -E "fallback|429|Gemini"
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

**–î–æ Fallback (–±–µ–∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):**
- OpenRouter –∏—Å—á–µ—Ä–ø–∞–Ω ‚Üí ‚ùå "Error: Failed after 12 attempts"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
- –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ –ø–æ–ª—É–Ω–æ—á–∏ UTC

**–° Fallback (—Å–µ–π—á–∞—Å):**
- OpenRouter –∏—Å—á–µ—Ä–ø–∞–Ω ‚Üí ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Gemini
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ~17s)
- –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7 –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤

**Uptime:** 99.9% (–¥–∞–∂–µ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ OpenRouter)

---

## üö® Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
ps aux | grep telegram_bot.py

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
tail -20 bot.log

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å fallback –≤–∫–ª—é—á—ë–Ω
grep "Gemini Direct API fallback" bot.log | tail -1
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úÖ Gemini Direct API fallback enabled"

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
./start.sh
```

---

### Fallback –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å google-auth —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
python3 -c "import google.auth; print('OK')"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ADC credentials
ls ~/.config/gcloud/application_default_credentials.json

# –ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:
gcloud auth application-default login
```

---

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (>20 —Å–µ–∫—É–Ω–¥)

**–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ** –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ OpenRouter:
- 4 –∫–ª—é—á–∞ √ó 4s retry = 16s
- Gemini API request = 1s
- **TOTAL:** ~17s

**–ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ OpenRouter (–ø–æ–ª–Ω–æ—á—å UTC):**
- –û—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å–Ω–æ–≤–∞ –±—ã—Å—Ç—Ä—ã–º–∏ (~0.3-0.8s)

---

## üìà –û–∂–∏–¥–∞–µ–º–æ–µ –ü–æ–≤–µ–¥–µ–Ω–∏–µ

### –î–æ –ø–æ–ª—É–Ω–æ—á–∏ UTC (—Å–µ–π—á–∞—Å):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí OpenRouter (429) ‚Üí Gemini ‚úÖ ‚Üí –û—Ç–≤–µ—Ç (~17s)
```

### –ü–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ UTC:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí OpenRouter (200) ‚úÖ ‚Üí –û—Ç–≤–µ—Ç (~0.3s)
```

### –ï—Å–ª–∏ OpenRouter —Å–Ω–æ–≤–∞ –∏—Å—á–µ—Ä–ø–∞–µ—Ç—Å—è –∑–∞–≤—Ç—Ä–∞:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí OpenRouter (429) ‚Üí Gemini ‚úÖ ‚Üí –û—Ç–≤–µ—Ç (~17s)
```

**–ë–æ—Ç –í–°–ï–ì–î–ê —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è fallback!** üéâ

---

## üéØ –ò—Ç–æ–≥–∏

‚úÖ Fallback –º–µ—Ö–∞–Ω–∏–∑–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7 –¥–∞–∂–µ –ø—Ä–∏ rate limits
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –æ—Ç–≤–µ—Ç—ã (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ fallback)
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ OpenRouter –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤
‚úÖ 1700 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å –≤–º–µ—Å—Ç–æ 200

**–ë–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üöÄ

---

**–î–∞—Ç–∞:** 22.11.2025 15:17
**PID:** 3531397
**Status:** ‚úÖ RUNNING
**Fallback:** ‚úÖ ENABLED
