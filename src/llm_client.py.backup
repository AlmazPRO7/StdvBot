import requests
import json
import logging
import base64
import time
from src.config import Config
from src.openrouter_manager import OpenRouterManager

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class GeminiClient:
    def __init__(self, provider="openrouter"):
        self.primary_provider = provider
        self.manager = OpenRouterManager()
        self.or_url = f"{Config.BASE_URL}/chat/completions"

    def generate(self, system_prompt, user_text, temperature=0.7):
        return self._execute(system_prompt, user_text, None, temperature, False)

    def generate_json(self, system_prompt, user_text):
        res = self._execute(system_prompt, user_text, None, 0.1, True)
        try:
            return json.loads(res.replace("```json", "").replace("```", "").strip())
        except:
            return {"error": "Invalid JSON", "raw": res}

    def generate_with_image(self, system_prompt, user_text, image_bytes):
        base64_image = base64.b64encode(image_bytes).decode('utf-8')
        return self._execute(system_prompt, user_text, base64_image, 0.5, False)

    def _execute(self, system_prompt, user_text, image_base64, temperature, json_mode):
        model = self.manager.get_best_free_model() # google/gemini-2.0-flash-exp:free
        
        user_content = [{"type": "text", "text": user_text}]
        if image_base64:
            user_content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/jpeg;base64,{image_base64}"}
            })

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_content}
        ]
        
        payload = {
            "model": model,
            "messages": messages,
            "temperature": temperature,
            "provider": {"allow_fallbacks": False} # Запрещаем авто-смену на платные
        }
        if json_mode: payload["response_format"] = {"type": "json_object"}

        # Максимальное упорство: пытаемся много раз, меняя ключи
        max_retries = 12 
        
        for attempt in range(max_retries):
            headers = self.manager.get_current_headers()
            try:
                response = requests.post(self.or_url, json=payload, headers=headers, timeout=45)
                
                if response.status_code == 200:
                    # Успех! Меняем ключ для балансировки
                    self.manager.rotate_key() 
                    content = response.json()['choices'][0]['message']['content']
                    if not content: raise Exception("Empty response")
                    return content
                
                elif response.status_code == 429:
                    logger.warning(f"⚠️ Rate Limit (429) on key ending ...{headers['Authorization'][-5:]}. Retrying...")
                    self.manager.rotate_key()
                    time.sleep(2) # Пауза перед следующим
                    
                elif response.status_code in [402, 401, 403]:
                    logger.error(f"❌ Key Error ({response.status_code}). Rotating.")
                    self.manager.rotate_key()
                    
                else:
                    logger.warning(f"⚠️ OpenRouter Error {response.status_code}: {response.text[:100]}")
                    self.manager.rotate_key()
                    time.sleep(2)

            except Exception as e:
                logger.error(f"❌ Network/API Error: {e}")
                self.manager.rotate_key()
                time.sleep(2)
        
        return f"Error: Failed after {max_retries} attempts. Service busy."
